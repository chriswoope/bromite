From: uazo <uazo@users.noreply.github.com>
Date: Mon, 8 Nov 2021 09:47:23 +0000
Subject: Disable Accessibility service by default

---
 .../browser/ui/android/strings/android_chrome_strings.grd   | 6 ++++++
 .../android/java/res/xml/accessibility_preferences.xml      | 5 +++++
 .../browser/accessibility/WebContentsAccessibilityImpl.java | 5 +++++
 3 files changed, 16 insertions(+)

diff --git a/chrome/browser/ui/android/strings/android_chrome_strings.grd b/chrome/browser/ui/android/strings/android_chrome_strings.grd
--- a/chrome/browser/ui/android/strings/android_chrome_strings.grd
+++ b/chrome/browser/ui/android/strings/android_chrome_strings.grd
@@ -5407,6 +5407,12 @@ To change this setting, <ph name="BEGIN_LINK">&lt;resetlink&gt;</ph>reset sync<p
       <message name="IDS_IMAGE_DESCRIPTIONS_SETTINGS_TITLE" desc="Title of the preference that allows user to update accessibility image descriptions settings. [CHAR_LIMIT=32]">
         Image descriptions
       </message>
+      <message name="IDS_ENABLE_ACCESSIBILITY_TITLE" desc="Title of enable accessibility settings, which allows the user to enable service. [CHAR_LIMIT=32]">
+        Enable Accessibility Service
+      </message>
+      <message name="IDS_ENABLE_ACCESSIBILITY_SUMMARY" desc="Summary of enable accessibility settings.">
+        Activates or deactivates the communication of all user activities in ui to the Accessibility provider
+      </message>
       <message name="IDS_IMAGE_DESCRIPTIONS_SETTINGS_TOGGLE_TITLE" desc="Title of the toggle to turn preference on and off for accessibility image descriptions.">
         Get image descriptions
       </message>
diff --git a/components/browser_ui/accessibility/android/java/res/xml/accessibility_preferences.xml b/components/browser_ui/accessibility/android/java/res/xml/accessibility_preferences.xml
--- a/components/browser_ui/accessibility/android/java/res/xml/accessibility_preferences.xml
+++ b/components/browser_ui/accessibility/android/java/res/xml/accessibility_preferences.xml
@@ -5,6 +5,11 @@
 
 <PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
 
+    <org.chromium.components.browser_ui.settings.ChromeBaseCheckBoxPreference
+        android:key="enable_accessibility"
+        android:summary="@string/enable_accessibility_summary"
+        android:title="@string/enable_accessibility_title" />
+
     <org.chromium.components.browser_ui.accessibility.TextScalePreference
         android:key="text_scale"
         android:title="@string/font_size"
diff --git a/content/public/android/java/src/org/chromium/content/browser/accessibility/WebContentsAccessibilityImpl.java b/content/public/android/java/src/org/chromium/content/browser/accessibility/WebContentsAccessibilityImpl.java
--- a/content/public/android/java/src/org/chromium/content/browser/accessibility/WebContentsAccessibilityImpl.java
+++ b/content/public/android/java/src/org/chromium/content/browser/accessibility/WebContentsAccessibilityImpl.java
@@ -886,6 +886,11 @@ public class WebContentsAccessibilityImpl extends AccessibilityNodeProviderCompa
             structure.setChildCount(0);
             return;
         }
+        // Do not collect accessibility tree if disabled
+        if (!ContextUtils.getAppSharedPreferences().getBoolean("enable_accessibility", false)) {
+            structure.setChildCount(0);
+            return;
+        }
         structure.setChildCount(1);
         final ViewStructure viewRoot = structure.asyncNewChild(0);
         viewRoot.setClassName("");
--
2.25.1
